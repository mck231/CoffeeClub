@page "/Voting"
@using BlazorVotingApp.Models
@inject HttpClient Http
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
<h3>Voting</h3>

<div>
    <label>Select Team:</label>
    <select @onchange="OnTeamSelected">
        <option value="">--Select a Team--</option>
        @foreach (var team in Teams)
        {
            <option value="@team.TeamId.ToString()">@team.Name</option>
        }
    </select>
</div>

@if (!string.IsNullOrEmpty(SelectedTeamId))
{
    <div>
        <label>Select User:</label>
        <select @onchange="OnUserSelected">
            <option value="">--Select a User--</option>
            @foreach (var user in TeamMembers)
            {
                <option value="@user.UserId.ToString()">@user.Name</option>
            }
        </select>
    </div>
}

@if (SelectedUserId != Guid.Empty)
{
    @if (VotingSessions.VotingSessions != null && VotingSessions.VotingSessions.Any())
    {
        <div>
            <label>Select Voting Session:</label>
            <select @onchange="OnVotingSessionSelected">
                <option value="">--Select a Voting Session--</option>
                @foreach (var session in VotingSessions.VotingSessions)
                {
                    <option value="@session.CoffeeGroupId.ToString()">@session.StartDate.ToShortDateString()</option>
                }
            </select>
        </div>
    }
}

 @if (IsVotingSessionActive && !HasVoted)
 {
     <div>
         <h3>Select Coffee:</h3>
         @foreach (var coffee in CoffeeSummariesList)
         {
             <input type="radio" id="@coffee.CoffeeId" name="coffeeVote" 
                    @onclick="@(() => SelectedCoffeeId = coffee.CoffeeId)" />
             <label for="@coffee.CoffeeId">@coffee.Name</label><br />
         }
         <button @onclick="SubmitVote">Submit Vote</button>
     </div>
 }


@if (HasVoted)
{
    <h4>Message Board</h4>
    <!-- SignalR message board goes here -->
    <!-- This will be updated in real-time as votes are cast -->
}


@code {
    private string SelectedTeamId = string.Empty;
    private Guid SelectedUserId = Guid.Empty;
    private bool IsVotingSessionActive = false;

    private List<CoffeeSelection> CoffeeSelections = new List<CoffeeSelection>();
    private List<CoffeeSummary> CoffeeSummariesList = new List<CoffeeSummary>();
    private List<Team> Teams = new List<Team>();
    private List<User> TeamMembers = new List<User>();
    private TeamVotingSessions VotingSessions = new TeamVotingSessions();

    private bool HasVoted = false;
    private Guid SelectedCoffeeId;

    
    protected override async Task OnInitializedAsync()
    {
        await FetchTeams();
    }

    private async Task FetchTeams()
    {
        var response = await Http.GetAsync("api/Team/getTeams");
        if (response.IsSuccessStatusCode)
        {
            Teams = await response.Content.ReadFromJsonAsync<List<Team>>();
        }
        else
        {
            // Handle error
        }
    }

    private async Task OnTeamSelected(ChangeEventArgs e)
    {
        SelectedTeamId = e.Value?.ToString() ?? string.Empty;
        if (Guid.TryParse(SelectedTeamId, out Guid teamId))
        {
            await FetchTeamMembers(teamId);
        }
    }

    private async Task FetchTeamMembers(Guid teamId)
    {
        var response = await Http.GetAsync($"api/Team?teamId={teamId}");
        if (response.IsSuccessStatusCode)
        {
            var team = await response.Content.ReadFromJsonAsync<Team>();
            TeamMembers = team.Members.Select(m => new User 
            { 
                UserId = m.UserId, 
                Name = m.Name 
            }).ToList();
        }
        else
        {
            // Handle error
        }
    }


    private async Task OnUserSelected(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value?.ToString(), out Guid userId))
        {
            SelectedUserId = userId;
            // Reset the VotingSessions to ensure old data isn't shown
            VotingSessions = new TeamVotingSessions();
            await CheckVotingSession();
        }
    }

    private async Task CheckVotingSession()
    {
        // Here you'll need to implement an API call to check if a voting session is active
        // and if the selected user is eligible to vote.
        // For now, it's just set to true for demonstration.
        await FetchVotingSessionsForTeam();
        IsVotingSessionActive = true; // This should be set based on the response from your API
    }

    private async Task FetchVotingSessionsForTeam()
    {
        var response = await Http.GetAsync($"api/VotingSession/byTeam/{SelectedTeamId}");
        if (response.IsSuccessStatusCode)
        {
            VotingSessions = await response.Content.ReadFromJsonAsync<TeamVotingSessions>() ?? new TeamVotingSessions();
            // Filter or validate sessions as needed
            
        }
        else
        {
            // Handle error
        }
    }
    
    private async Task OnVotingSessionSelected(ChangeEventArgs e)
    {
        var coffeeGroupIdStr = e.Value?.ToString();
        if (!string.IsNullOrEmpty(coffeeGroupIdStr) && Guid.TryParse(coffeeGroupIdStr, out Guid coffeeGroupId))
        {
            await FetchCoffeeOptions(coffeeGroupId);
            IsVotingSessionActive = true;
        }
        else
        {
            IsVotingSessionActive = false;
        }
    }

    private async Task FetchCoffeeOptions(Guid coffeeGroupId)
    {
        var response = await Http.GetAsync($"api/CoffeeSelection/{coffeeGroupId}");
        if (response.IsSuccessStatusCode)
        {
            var coffeeSelection = await response.Content.ReadFromJsonAsync<CoffeeSelection>();
            CoffeeSummariesList = coffeeSelection.Coffees.ToList();
        }
        else
        {
            // Handle error
        }
    }

    
    private async Task SubmitVote()
    {
        // Send the selected coffee ID to the server
        // Replace with your API endpoint and method
        var response = await Http.PostAsJsonAsync("api/Vote", new { CoffeeId = SelectedCoffeeId, UserId = SelectedUserId });

        if (response.IsSuccessStatusCode)
        {
            HasVoted = true;

            // Initialize SignalR connection for real-time updates
            await InitializeSignalR();
        }
        else
        {
            // Handle error
        }
    }

    private async Task InitializeSignalR()
    {
        // Ensure the path to the JavaScript file is correct
        // Typically, this should be a root-relative path
        var module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", new object[] { "/javascript/signalr.js" });
        await module.InvokeVoidAsync("initializeSignalR", "/votingHub");
    }


}
